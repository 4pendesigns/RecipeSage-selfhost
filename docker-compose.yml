version: '3.7'
services:
  proxy:
    image: nginx
    volumes:
    - ./proxy.conf:/etc/nginx/conf.d/default.conf
    ports:
    - 80:80
    command: nginx -g 'daemon off;'
    depends_on:
      - static
      - api
      - pushpin
    restart: unless-stopped
  static:
    image: julianpoy/recipesage-selfhost:static-latest
    command: bash -c "sed -i 's/API_BASE_OVERRIDE = null/API_BASE_OVERRIDE = \"\/api\/\"/' /usr/share/nginx/html/index.html && nginx -g 'daemon off;'"
    restart: unless-stopped
  api:
    image: julianpoy/recipesage-selfhost:api-latest
    depends_on:
      - postgres
      - elasticsearch
      - pushpin
      - browserless
    command: /app/www
    environment:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_REGION=us-west-2
      - AWS_BUCKET=chefbook-dev
      - NODE_ENV=selfhost
      - VERBOSE=false
      - VERSION=self-host
      - POSTGRES_DB=recipesage_selfhost
      - POSTGRES_USER=recipesage_selfhost
      - POSTGRES_PASSWORD=recipesage_selfhost
      - POSTGRES_PORT=5432
      - POSTGRES_HOST=postgres
      - POSTGRES_SSL=false
      - POSTGRES_LOGGING=false
      - GCM_KEYPAIR
      - SENTRY_DSN
      - GRIP_URL=http://pushpin:5561/
      - GRIP_KEY=changeme
      - ELASTIC_ENABLE=true
      - ELASTIC_IDX_PREFIX=rs_selfhost_
      - ELASTIC_CONN=http://elastic:recipesage_selfhost@elasticsearch:9200
      - ELASTIC_PASSWORD=recipesage_selfhost
      - STRIPE_SK
      - STRIPE_WEBHOOK_SECRET
      - BROWSERLESS_HOST=browserless
      - BROWSERLESS_PORT=3000
    restart: unless-stopped
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.6.1
    environment:
      - discovery.type=single-node
      - ELASTIC_PASSWORD=recipesage_selfhost
    volumes:
      - elasticsearchdata:/usr/share/elasticsearch/data
    restart: unless-stopped
  pushpin:
    image: fanout/pushpin:1.27.0
    environment:
      - target=api:3000
    restart: unless-stopped
  postgres:
    image: postgres
    environment:
      - POSTGRES_DB=recipesage_selfhost
      - POSTGRES_USER=recipesage_selfhost
      - POSTGRES_PASSWORD=recipesage_selfhost
    volumes:
      - postgresdata:/var/lib/postgresql/data
    restart: unless-stopped
  browserless:
    image: browserless/chrome:1.28.0-chrome-stable
    environment:
      - MAX_CONCURRENT_SESSIONS=3
      - MAX_QUEUE_LENGTH=10
    restart: unless-stopped
volumes:
  elasticsearchdata:
    driver: local
  postgresdata:
    driver: local
